#summary How to compile IMMS on Windows

= Building IMMS on Windows =

IMMS on Windows is a work in progress. The main options are compiling using Cygwin or MinGW. MinGW is preferred as this results in a native executable. Building IMMS under Cygwin means we would have to distribute the cygwin dll(s) along with the IMMS installation, adding an unnecessary dependency.


This has only been tested on Windows XP (SP3).

== Building with MinGW ==

*Note:* if you have both cygwin and mingw installed on your machine this may cause problems, as mingw may pick up some paths from the Windows environment variable. When you launch the MSYS terminal, check your path ('set path'). You may want to change your path to not include anything with cygwin!

See also "MinGW related" at the MinGW FAQ - http://www.mingw.org/wiki/FAQ

*Note:* IMMS on mingw has only been tested for compilation, not running. Still working on that.


*1.* Download mingw from mingw.org. The files might be at http://sourceforge.net/projects/mingw/files_beta/Automated%20MinGW%20Installer/ . You want the Automated Installer.

When installing, install the base system with C compiler, the C++ compiler, the fortran compiler, MSYS, and MinGW Developer Toolkit. See http://www.mingw.org/wiki/Getting_Started .

*2.* Download the IMMS code to a folder inside the Mingw installation, such as ~/imms (i.e. C:\MinGW\msys\1.0\home\{yourusername}\imms , if you installed Mingw to C:\Mingw).

*3.* Open a new MSYS prompt (select 'MinGW Shell' from the Start menu) and cd into the directory with the IMMS code.

*4.* Get ready to download some requirements! :D

*a) zlib* http://www.zlib.net/
 * cd into the folder
 * If you try to run ./configure from mingw you will probably get "Please use win32/Makefile.gcc instead."
 * Do "make -f win32/Makefile.gcc"
 * You will need to add some lines to your path before you can install zlib. Try either of these options. Either way you will run the same make command: 'make install -f win32/Makefile.gcc'

option 1: prepend the path variable before you call make:
>'BINARY_PATH=/mingw/bin INCLUDE_PATH=/mingw/include LIBRARY_PATH=/mingw/lib make install -f win32/Makefile.gcc'

option 2: add the path definitions inside your win32/Makefile.gcc file:

    BINARY_PATH=/mingw/bin<br>
    INCLUDE_PATH=/mingw/include<br>
    LIBRARY_PATH=/mingw/lib<br>

, then install zlib with 'make install -f win32/Makefile.gcc'


*b) sqlite* http://www.sqlite.org/download.html

 * you probably want the 'amalgamation' tar.gz, that contains the configure script and makefile
 * everything should compile fine in mingw with sqlite 3.7.3, but we need to specify different installation paths for the header files and libraries/dlls. Instead of just './configure', run:

    ./configure --prefix=/mingw<br>
    make<br>
    make install<br>

*c) glib.* http://www.gtk.org/download-windows.html

You want the latest 'Sources' for glib.

Note: If you grabbed autotools as part of the msysDTK rather than using the MinGW Developer Toolkit you may need to compile libiconv and gettext before you can build glib. If so see instructions in the "Other ways to get autotools on MinGW" section below.

Note: it's possible that this could be done with just the glib Dev files. Feel free to try and let the list know how it goes.

    ./configure --prefix=/mingw<br>
    make<br>
    make install<br>


*d) pkg-config.* http://pkgconfig.freedesktop.org/releases/

Get the latest release; this guide used 0.25.

    ./configure --prefix=/mingw<br>
    make<br>
    make install<br>

*e) pcre* http://sourceforge.net/projects/pcre/files/

your favourite mantra again:

    ./configure --prefix=/mingw<br>
    make<br>
    make install<br>

note: if you don't have pkg-config installed first, you might see an error like

    "checking for pkg-config... no<br>
    checking for pcre... configure: error: PCRE required and missing."

this is actually an error with pkg-config, not pcre. to fix, install pkg-config first.

*f) fftw*

It's no problem! Wonderful fftw users have already practised compiling under mingw :)

 * Download from http://www.fftw.org/download.html
 * View the mingw steps on http://www.fftw.org/install/windows.html

Basically we use their recommended switches and add our prefix

    ./configure --with-our-malloc16 --with-windows-f77-mangling --enable-shared --disable-static --enable-threads --with-combined-threads --enable-portable-binary --enable-sse2 --prefix=/mingw<br>
    make<br>
    make install<br>

making fftw may take a while.

*g) torch*

We're using torch3 - download from http://www.torch.ch/downloads.php

*Note:* getting torch compiled is a bit tricky. This uses the source code and gnu make options. It may be easier to try xmake, but that involves installing python; it may be easier to build with visual c++ as well, but that requires visual c++. Feel free to experiment and ping the list with your results.


Torch doesn't compile on mingw by default; we get to edit the makefile. To fix the makefiles you have two choices:
 # Edit the makefiles and change "OS := $(shell uname -s)" to "OS := Linux". This will need to be done in each subdirectory where you want to build Torch components (in our case: 'core', 'distributions', and 'gradients').
 # Copy the "Makefile_options_Linux" makefile and rename it to "Makefile_options_MINGW32_NT-5.1" (where "MINGW32_NT-5.1" is the name reported by 'uname -s' in your MSYS terminal). This will need to be done in each subdirectory where you want to build Torch components (in our case: 'core', 'distributions', and 'gradients').

(I have contacted the Torch owners to see if they will accept a patch in the form of a mingw makefile. We'll see)


For this guide we'll be doing the second option.

 * Next, change all of the lines in the Makefiles that read "@\rm -Rf to "@rm -Rf". These are mostly in the 'clean:' directive. If you leave in the '\', make will give you errors like "{{{make[1]}}}: \rm: Command not found". This will need to be done in each subdirectory where you want to build Torch components ('core', 'distributions', and 'gradients').
 * Also change all lines that read "@\mkdir" to "@mkdir", or you'll get the same error. These are mostly in the "depend:" section. This also has to be done in each file.

 * Next, edit the Makefile_options_g++ file(s):
    * Remove the "-mcpu=i686" flag from CFLAGS_OPT_DOUBLE and CFLAGS_OPT_DOUBLE. otherwise gcc will tell you "-mcpu is deprecated".
    * Add the proper include directory to MYINCS; in this case "MYINCS = -I/mingw/include". TODO: may change if our directories change. try from scratch.

 * Edit the Makefile_options_MINGW32_NT-5.1 file (or Makefile_options_Linux file):
    * Remove the "-mcpu=i686" flag from CFLAGS_OPT_DOUBLE and CFLAGS_OPT_DOUBLE.
    * Add the proper include directory to MYINCS; in this case "MYINCS = -I/mingw/include". TODO: may change if our directories change.
    * Change the PACKAGES line to include the extra packages we need for IMMS: "PACKAGES = distributions gradients".


 * HACK: currently Torch3/core/Timer.cc doesn't compile because it needs some functions in sys/time.h, which are not provided by MinGW. Fortunately, we don't use any Timer stuff inside IMMS (TODO: right?), so we can work around this rather than fixing it. Because of the way the Torch makefiles work, if you remove the Timer.cc file or rename it to something other than '.cc', Torch will ignore it. So do that now.<br><br>Long term: we could try using gnulib to patch in support for the needed functions. That's a lot for something we don't use though.


 * We should now be ready. Build torch by running 'make depend' and then 'make'. They may take a while.
 * Torch3 doesn't have a 'make install' option, so we get to install the files ourselves :P (Note: I have contacted the owners to see if they will accept a patch for this too).
    * Copy the header files from the 'core' (except Timer.h :P), 'distributions', and 'gradients' folders to /mingw/include/torch/ (C:\MinGW\include\torch on Windows).
    * Copy the compiled 'libtorch.a' library file from Torch3/libl/MINGW32_NT-5.1_OPT_FLOAT (or Torch3/liblLinux_OPT_FLOAT, if you used the Linux makefile) to /mingw/lib (C:\MinGW\lib in Windows).


*h) sox* http://sox.sourceforge.net/

Easy. Grab the source code, then your favourite mantra

    ./configure<br>
    make -s (-s is specified in the INSTALL doc)<br>
    make install<br>


*5.* Other compilation issues

IMMS will now be able to pass and run the entire configure script. However, there are numerous problems with building IMMS natively on Windows.

a) IMMS has a signal for SIGPIPE, but Windows as an OS doesn't support or implement SIGPIPE. Possible solution: We can wrap that one definition in an #ifdef. In immsd.cc change

    {{{
    // SIGPIPE is not supported on Windows, so ignore it if we're building under MinGW
    // TODO: find reference
    // TODO: is this the right #ifdef to use?
    // TODO: this requires adding a unit test - what happens if we try to open a closed file socket on Windows?
    #ifndef __MINGW32__
    signal(SIGPIPE, quit);
    #endif
    }}}

b) mkdir. on POSIX systems this function takes 2 arguments (directory, permissions); on Windows it takes 1 (directory). We could possibly get around this by redefining the function for windows:

{{{
#ifdef _WIN32
# define  mkdir( D, M )   _mkdir( D )
#endif
}}}

This would have to be tested.

c) The constant 'ERROR' is already defined in MinGW, in include/wingdi.h. To get around this we could redefine 'ERROR' and 'INFO' to 'IMMSERROR' and 'IMMSINFO'. This would affect immsd/immsd.cc and immscore/fetcher.cc.

d) srandom. This is not supplied by minGW or gnulib. We could potentially add

{{{
#ifdef WIN#@
#define random rand
#define srandom srand
#endif
}}}

to immscore/immsutil.cc. This would need to be tested.

e) realpath. This is supposedly supplied by gnulib, but I haven't gotten it to work yet. Note that IMMS currently builds without using 'automake', so we may have to add some automake parts to the IMMS build system for gnulibe to be able to import realpath. This would need to be tested so it doesn't break the Linux version of IMMS.

 * Import gnulib realpath code with
    {{{../prereqs/gnulib-HEAD-b392a22/gnulib-tool --source-base=gnulib --m4-base=gnulib/m4 --import canonicalize-lgpl}}}
 * gnulib requires a newer version of autoconf, so we'd have to update IMMS {{{ }}} to {{{}}}
 * add "gnulib/Makefile" to AC_CONFIG_FILES in ./configure.ac,
 * invoke gl_EARLY in ./configure.ac, right after AC_PROG_CC,
 * invoke gl_INIT in ./configure.ac.

 * Then set up the IMMS build system so it can use automake too
   * Create a 'Makefile.am' file in the main IMMS directory
   * mention "gnulib" in SUBDIRS in Makefile.am,
   * mention "-I gnulib/m4" in ACLOCAL_AMFLAGS in Makefile.am,
   * add AM_INIT_AUTOMAKE to configure.ac
   * copy in the 'missing', depcomp, config.guess, and config.sub files from automake 1.11 TODO: or use 'automake --add-missing'?
   * add AC_PROG_RANLIB to configure.ac, right after AC_PROG_CC.
   * either call aclocal with the new -I flag ('aclocal -I gnulib/m4') TODO: or add it to INCLUDES in vars.mk? TODO: how can we make missing gl_EARLY and gl_INIT macros an error rather than a warning?
 * Add the gnulib dir to the -I include flags for the compiler? And add some flags to the linker?

still doesn't work even with all that though :-/

f) nanosleep is another linux command not present on mingw. TODO supplied by gnulib?

z) sockets. We may have to change over to winsock, which involved some #ifdefs?

To compile we need to change at least:

in immscore/immsutil.cc

{{{
#ifdef WIN32
   #include <winsock.h>
#else
   #include <sys/socket.h>
   #include <sys/un.h>
#endif
}}}

 * and adding an init call on windows
 * and add a linker flag on windows

it may require a bunch of other stuff though (including fcntl, below)

zz) fcntl. This doesn't exist/work on MinGW with F_SETFD. We could possibly substitute something like

    {{{
#ifndef __MINGW32__

        fcntl(fd, F_SETFD, O_NONBLOCK);

        #else

        u_long *argp = 1; // TODO: only needed on Windows?
        // set socket to non-zero value so that nonblocking mode
        // is enabled
        // http://msdn.microsoft.com/en-us/library/ms738573%28VS.85%29.aspx

        int sret = ioctlsocket(fd, FIONBIO, argp);  //TODO: this requires using Winsocks.
        if (sret != 0)
        {
            // TODO: check for errors with WSAGetLastError().
        }

        #endif
    }}}

however, this may really be an issue with file sockets. The real fix may require changing to an IP socket on windows.

zzz) kill. This function doesn't exist in mingw. If we were actually trying to terminate a process we could perhaps substitute for {{{raise()}}} on win32 systems, but the code looks like it's just trying to see if a file exists. This may have to deal with file sockets and might have to be part of the system rewrite for windows.

zzzz) {{{../immscore/immsutil.cc:205:24: error: aggregate 'socket_connect(const std::stri
ng&)::sockaddr_un sun' has incomplete type and cannot be defined.}}} This is because struct sockaddr_un sun isn't defined on windows? This may necessitate switching to winsock, along with other socket things? Or is there something else we can do?


These problems are still being addressed. More to come soon...


*6.* Finally! Configure and make imms

    ./configure<br>
    make




=== Troubleshooting on MinGW ===

MinGW Troubleshooting

*Q: SQLite won't compile! All it says is "make: *** {{{[sqlite3.lo]}}} Error 1"*

*A:* Did anything weird happen when configuring? Check your configure output, and/or your configure.log. In particular you may see messages like "Bad file number".

Note: if you have both cygwin and mingw installed on your machine this may cause problems, as mingw may pick up some paths from the Windows environment variable. When you launch the MSYS terminal, check your path ('set path'). You may want to change your path to not include anything with cygwin!

 
*Q: When compiling autoconf I get weird messages like "The system cannot find the path specified. autom4te: need GNU m4 1.4 or later". What gives?*

*A:* Autoconf is not buildable from source under msys or mingw. This is the official statement from the maintainer. Don't try to compile autoconf or m4 yourself - instead, download the msysDTK ("Developer Tool Kit") from  http://sourceforge.net/projects/mingw/files/ and install it to get a copy of autoconf (see instructions above).

*Q: When running ./configure for IMMS I get messages like "possibly undefined macro: PKG_CONFIG_LIBDIR", "possibly undefined macro: AC_MSG_ERROR", or "syntax error near unexpected token `pcre,' `PKG_CHECK_MODULES(pcre, libpcre, , with_pcre=no)'".*

*A:* This is an issue with autotools not finding the right m4 macros, similar to the entry in the FAQ http://imms.luminal.org/faq#TOC-I-get-an-error-about-undefined-macr . Because we have been installing things to /mingw and the autotools only look in /usr/local by default, we need to tell them about it (TODO: may be easier to just build everything in /usr/local?) . Unfortunately each autotool has a different syntax, but you can fix this by calling them with

autoheader --include=/mingw
aclocal -I /mingw
autoconf --include=/mingw

TODO: either avoid this or patch the -I into the makefile if uname matches mingw?


=== Other ways to get autotools on MinGW ===

To build IMMS we need autoconf and several other autotools to create out 'configure' file, but MSYS itself does not ship with autotools. In fact, autoconf is not buildable under the current version of msys - this is the official statement by the maintainer; you will get weird error messages about "The system cannot find the path specified. autom4te: need GNU m4 1.4 or later". Thankfully, one of the mingw authors distributes pre-built versions of the autotools and perl as part of the MSYS Developer Toolkit (or msysDTK).

So there are several ways to get these autotools:
 # Install the MinGW Developer Toolkit as part of your initial MinGW installation, as described above
 # Download the latest msysDTK (MSYS Developer Toolkit) installer exe from http://sourceforge.net/projects/mingw/files/ .
   ** Run the exe to install the latest msysDTK package to get a copy of autotools. Note: you may need to run the installer as an Administrator for it to successfully modify C:\WINDOWS\MSYS.INI
   ** When the installer asks you for a path, install to C:\MinGW\msys\1.0 so the tools get added to the same directory as the other msys tools.
 # Grab the msysDTK with mingw-get (unconfirmed; let the list know if you try this)

If you use the msysDTK you will need to build libiconv and gettext yourself in order to compile glib.


*1) libiconv* (for gettext) http://www.gnu.org/software/libiconv/#downloading

We follow some of the instructions in the 'README.woe32' file, but some are out of date. Remove the '-mno-mingw' flag, since it is no longer supported by cygwin.

   PATH=/mingw/bin:$PATH
   export PATH
   ./configure --host=i586-pc-mingw32 --prefix=/mingw \
     CPPFLAGS="-Wall -I/mingw/include" \
     CFLAGS="-O2 -g" \
     CXXFLAGS="-O2 -g" \
     LDFLAGS="-L/mingw/lib"


*2) gettext* (for glib) http://www.gnu.org/software/gettext/


Again, we follow only some of the instructions in the 'README.woe32' file. Definitely do *NOT* specify the old GCC version numbers.

   PATH=/mingw/bin:$PATH
   export PATH
   ./configure --prefix=/mingw \     
     CPPFLAGS="-Wall -I/mingw/include" \
     LDFLAGS="-L/mingw/lib"

configuring and making may both take a long time.


PROBLEM: When building gettext I get an error like

  ./libxml/encoding.h:29:19: fatal error: iconv.h: No such file or directory

A: Have you installed libiconv? Build and install that before installing gettext.

PROBLEM: When building gettext I get an error like

    undefined reference to `str_cd_iconveh'

A: If you read the gnu README.woe32 files you will notice that it says gettext and all dependencies have to be built with the same flags. 





== Building with Cygwin ==

If you like you can also compile IMMS under Cygwin. This is easier than MinGW because cygwin supplies many POSIX-expected functions, files, and libraries. However, the resulting IMMS programs depend on the Cygwin .dlls to run; for this reason Cygwin builds are unofficial and will not be distributed through the IMMS website.

TODO: transfer cygwin stuff here from http://imms.luminal.org/download/immswindowscygwin .